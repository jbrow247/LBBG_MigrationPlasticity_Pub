---
title: "Results"
author: "Morgan Brown"
date: '2020-06-25'
output:
  word_document: default
  html_document:
    df_print: paged
  pdf_document: default
---

Readme:

This Rmarkdown produces the text in the results section, as well as most of the figures and tables in the manuscript.  It relies on data generated from LBBG_plasticity_pub.R, which takes approximately a day to run.  


```{r setup, include = F}
knitr::opts_chunk$set(fig.width=12, fig.height=8, fig.path='Fig.s/',
                      echo = F, message=FALSE, include = F)

setwd("D:/surfdrive/PhD/Research/Plasticity of migratory strategies/R/Publication_version/Plasticity_pub")
library(lme4)
library(lubridate)
library(tidyverse)
library(rptR)
library(broman)
library(knitr)
library(cowplot)
select<- dplyr::select

map.world <- rworldmap::getMap("low")
map.world <- fortify(map.world)

###Converts Julian Date to calendar date
jultodate <- function(x){
  date <- as.Date(x-1, origin = "1970-01-01")
  paste (day(date), month(date, label = T, abbr = F), sep = " ")
}

```

```{r load data}
gull <- readRDS("gull.glm.RDS")
gull$year <- year(gull$start) + gull$birdyear ###start = year of deployment. ##birdyear = starts at 0, and goes up each year
gull$sex <- as.factor(ifelse(gull$sex == "FALSE", "F", ifelse(gull$sex == "X", NA, gull$sex)))  ##from pgAdmin, all false should be F. Not sure what caused change
gull <- filter(gull, !is.na(mig.dist))  ##many birds removed because couldn't calculate KDE

###convert arrivals to julian date so can compare across years.  because circular, check to make sure values that cross over new years can be linear (add 365 for dates starting Jan1)
gull$col.arrival <- yday(gull$col.arrival) 

gull$col.depart <- yday(gull$col.depart) 

gull %>% ggplot(aes(yday(winter.arrive))) + geom_histogram()
##add 365 days to dates before yday 100
gull$winter.arrive <- if_else(yday(gull$winter.arrive)>100,yday(gull$winter.arrive), yday(gull$winter.arrive)+365) 

gull %>% ggplot(aes(yday(winter.depart))) + geom_histogram()
gull$winter.depart <- yday(gull$winter.depart)

gull <- gull %>% group_by(id) %>% mutate(mn.mig = mean(mig.dist), med.mig = median(mig.dist), n.yrs = length(mig.dist)) %>% arrange(med.mig) %>% ungroup()
gull$id <- factor(gull$id)

##remove gull dates occuring in a gap. lns 563-572 in LBBG_plasticity_pub.R
##5215 by 0  col.depart, 5554 by 0 winter.arrive, 459 by 1 winter arrive
gull[gull$id == 5215,]$col.depart <- NA
gull[gull$id == 5554,]$winter.arrive <- NA
gull[gull$id == 459,]$winter.arrive <- NA
```

```{r stopover & p overlap}
id.with.stop <- gull %>% mutate(stopover = ifelse(n.winter.p > 1, T, F)) %>% group_by(id) %>% summarise(nostop = all(!stopover)) %>% filter(nostop == F) %>% pull(id) ## ids that use a stopover in 1 year

no.so.overlap <- filter(gull, !is.na(p.no.overlap)) %>% select(id) %>% distinct() ## ids with a stopover that doesn't overlap in another year

no.wa.overlap <- filter(gull, change.wa == T) %>% pull(id)
no.wa.overlap <- unique(no.wa.overlap)
```

```{r mig.dist repeatability}
r.md <- rptR::rpt(mig.dist ~ (1 | id) + (1 | col), grname = c("id", "col"), data = gull, 
            datatype = "Gaussian", nboot = 1000, npermut = 1000)

lmm.md <- lmer(mig.dist ~ (1 | id)+ (1 | col), data = gull)

idres.md <- data.frame(id = gull$id, resid = resid(lmm.md))

idvar.md <- idres.md %>% group_by(id) %>% summarise(idvar = mean(resid^2)) ##calculate indivdiuals residual variance
idvar.md <- gull %>% select(id, med.mig) %>% distinct() %>% full_join(idvar.md)
btwnvar <- VarCorr(lmm.md)[[1]][1]
idvar.md$r <- btwnvar/(btwnvar+idvar.md$idvar)
```

```{r wa site fidelity}
sf.ol<-gull %>% group_by(id) %>% select(id, med.mig, sf_mn_overlap) %>% distinct()
sf.lm <- lm(sf_mn_overlap ~ med.mig, data = sf.ol)
sf.lm.0 <- lm(sf_mn_overlap ~ 1, data = sf.ol)
lrt.sf <- anova(sf.lm.0, sf.lm)

median(sf.ol$sf_mn_overlap)

```

```{r overlap lm & randomization tests}

###linear model of range overlap with migration distance
wa.ol<-gull %>% group_by(id) %>% mutate(max.n.wa = max(n.winter.p)) %>% select(id, med.mig, mn_overlap, max_overlap, max.n.wa) %>% distinct()
wa.ol.lm <- lm(mn_overlap ~ med.mig, data = wa.ol)
wa.ol.lm.0 <- lm(mn_overlap ~ 1, data = wa.ol)
lrt.ol <- anova(wa.ol.lm.0, wa.ol.lm)

#randomization tests
rand.UD_overlap <- readRDS("rand_overlap.RDS") ## list of overlaps from random pairs
r.pair.ol <- readRDS("r.pair.ol.RDS") ##df overlap combinations
remove(rand.UD_overlap_range)
rand.UD_overlap_range  <- data.frame(matrix(ncol = 1, nrow = length(rand.UD_overlap)))
for(i in 1:length(rand.UD_overlap)){ #for each random birdyear pair
  overlap <- rand.UD_overlap[[i]]
  range <- overlap[1,2] ##select overlap between home-range, not with itself...
  rand.UD_overlap_range[i,] <- range ## range = overlap
}

colnames(rand.UD_overlap_range) <- c("overlap")
rand.UD_overlap_range$id <- r.pair.ol$id_birdyear ##id birdyear 1
rand.UD_overlap_range$p.id <- r.pair.ol$p.id_birdyear ##id birdyear 2
rand.UD_overlap_range$pair <- "Between" ##indicate between bird pair

rand.ol <- rand.UD_overlap_range %>% select(overlap, pair)
tmp <- gull %>% select(overlap = mn_overlap) %>% mutate(pair = "Within") ##select lowest within indivdiual overlap
rand.ol <- rbind(rand.ol, tmp) ## combine with random overlaps

rand.ol$pair <- factor(rand.ol$pair)

##Actual overlap between random pairs versus within individuals
bp.ol <- ggplot(rand.ol, aes(pair, overlap)) + geom_boxplot() +ylab("Nonbreeding Range Overlap") + theme(axis.title.y = element_text(size = 9),  axis.text = element_text(size = 9), axis.title.x = element_blank())


######Randomization

##First calculate actual difference in overlap between within indivdiual versus between random individuals
n1 <- length(rand.ol$overlap[rand.ol$pair == "Within"])
n2 <- length(rand.ol$overlap[rand.ol$pair == "Between"])
N <- n1 + n2
pair1 <-  rand.ol$overlap[rand.ol$pair == "Within"]
pair2 <-  rand.ol$overlap[rand.ol$pair == "Between"]

md1 <- median(pair1, na.rm = T) ##actual within indivdiual median overlap
md2 <- median(pair2, na.rm = T )##actual between indivdiual median overlap

par(mfrow = c(2,1))
hist(pair1, col = "red", xlim = c(min(rand.ol$overlap), max(rand.ol$overlap)) )
hist(pair2, col = "green", xlim = c(min(rand.ol$overlap), max(rand.ol$overlap)))
dev.off()

obt.med.diff <- md1 - md2
cat("The actual median difference is ", '\n', obt.med.diff, '\n')

#### Randomize the overlaps 
set.seed(205)
nreps = 10000
samp.med.diff <- numeric(nreps)
samp.med <- numeric(nreps)
for (i in 1:nreps) {
  resamp.rand.ola <- sample(rand.ol$overlap, length(rand.ol$overlap), replace = FALSE)
  Grp1 <-  resamp.rand.ola[1:n1]
  Grp2 <-  resamp.rand.ola[(n1+1):N]
  rmd1 <- median(Grp1, na.rm = T)
  rmd2 <- median(Grp2, na.rm = T )
  samp.med.diff[i] <- rmd1 - rmd2  ### difference between groups of the randomized data set
  samp.med[i] <- rmd1
}
obt.med.diff <- abs(obt.med.diff)
pUpper <- length(samp.med.diff[samp.med.diff >= obt.med.diff]) /nreps
pLower <- length(samp.med.diff[samp.med.diff <= (-1)*obt.med.diff])/nreps
pExtreme.ol <- pLower + pUpper ### probability of obtainin a difference between within and between individual overlaps as found in the actual data set
obt.med.diff.ol <- obt.med.diff ##actual difference in overlaps

mdw.ol <- md1 ##actual median within indiviual overlap
mdb.ol <- md2 ##actual median between indivdiual overlap

```

```{r routes lm and randomization}
mn_traj <- readRDS("mn_traj_limitlat.RDS")

##Does route variation change with  migration distance? Linear model. 
mn_traj$id <- factor(mn_traj$id)
wtraj <- mn_traj %>% group_by(id, direction) %>% summarise(wvar = mean(within.var)) 
wtraj <- gull %>% group_by(id) %>% summarise(med.mig = median(mig.dist, na.rm = T)) %>% right_join(wtraj)
wtraj <- wtraj %>% mutate(v.scale = wvar/med.mig)
##spring
wtraj.s <- filter(wtraj, direction == "Spring")
lm.w.s<- lm(wvar ~ med.mig, data = wtraj.s)
null <- lm(wvar ~ 1, data = wtraj.s)
anova(lm.w.s)
lrt.w.s <- anova(null,lm.w.s)

##Autumn
wtraj.f <- filter(wtraj, direction != "Spring")
lm.w.f <- lm(wvar ~ med.mig, data = wtraj.f)
anova(lm.w.f)
lrt.w.f <- anova(lm(wvar ~ 1, data = wtraj.f), lm.w.f)

#########################################
## Randomization tests ##

rand_traj_sum <- readRDS("rand_traj_sum.RDS")
r.pair <- readRDS("r_pair_traj.RDS")

mn_traj_sum <- mn_traj %>% group_by(id, direction) %>% summarise(mn_var = mean(within.var), pair = "Within") %>% ungroup() ### within indivdiual pairs (actual), both directions

##between indivdiual pairs per direction
rand.t.f <- rand_traj_sum %>% filter(direction == "Autumn") %>% ungroup() %>% select(mn_var, pair) 
rand.t.s <- rand_traj_sum %>% filter(direction == "Spring") %>% ungroup() %>% select(mn_var, pair)                        
## combine within and between indivdiual variances into a single df per direction
tmp <- mn_traj_sum %>% filter(direction == "Autumn") %>% select(mn_var, pair)  #56
rand.t.f <- rbind(rand.t.f, tmp)
tmp <- mn_traj_sum %>% filter(direction == "Spring")%>% select(mn_var, pair) # 73 ( vs 73, 100)
rand.t.s <- rbind(rand.t.s, tmp)

rand.t.f$pair <- factor(rand.t.f$pair)
rand.t.s$pair <- factor(rand.t.s$pair)

##actual differences in variation (beween vs within) per direction
bp.tf <- ggplot(rand.t.f, aes(pair, mn_var)) + geom_boxplot()+ylab("Mean autumn route variance (km)") + theme(axis.title.y = element_text(size = 9),  axis.text = element_text(size = 9), axis.title.x = element_blank()) + ylim(310, 0)
bp.ts <- ggplot(rand.t.s, aes(pair, mn_var)) + geom_boxplot() +ylab("Mean spring route variance (km)") + theme(axis.title.y = element_text(size = 9),  axis.text = element_text(size = 9), axis.title.x = element_blank())+ ylim(310, 0)

################Autumn
n1 <- length(rand.t.f$mn_var[rand.t.f$pair == "Within"])
n2 <- length(rand.t.f$mn_var[rand.t.f$pair == "Between"])
N <- n1 + n2
pair1 <-  rand.t.f$mn_var[rand.t.f$pair == "Within"]
pair2 <-  rand.t.f$mn_var[rand.t.f$pair == "Between"]

md1 <- median(pair1, na.rm = T)
md2 <- median(pair2, na.rm = T )

mdw.tf <- md1 ##median within individual variance in autumn migration routes
mdb.tf <- md2 ##median betwen individual variance in autumn migration routes

par(mfrow = c(2,1))
hist(pair1, col = "red", xlim = c(min(rand.t.f$mn_var), max(rand.t.f$mn_var)) )
hist(pair2, col = "green", xlim = c(min(rand.t.f$mn_var), max(rand.t.f$mn_var)))
dev.off()

obt.med.diff <- md1 - md2
cat("The actual median difference is ", '\n', obt.med.diff, '\n')

nreps = 10000
samp.med.diff <- numeric(nreps)
samp.med <- numeric(nreps)
for (i in 1:nreps) {
  resamp.rand.t.fa <- sample(rand.t.f$mn_var, length(rand.t.f$mn_var), replace = FALSE)
  Grp1 <-  resamp.rand.t.fa[1:n1]
  Grp2 <-  resamp.rand.t.fa[(n1+1):N]
  rmd1 <- median(Grp1, na.rm = T)
  rmd2 <- median(Grp2, na.rm = T )
  samp.med.diff[i] <- rmd1 - rmd2
  samp.med[i] <- rmd1
}
obt.med.diff <- abs(obt.med.diff)
pUpper <- length(samp.med.diff[samp.med.diff >= obt.med.diff]) /nreps
pLower <- length(samp.med.diff[samp.med.diff <= (-1)*obt.med.diff])/nreps
pExtreme.tf <- pLower + pUpper ## probability of obtaining a difference as extreme as the actual dataset
obt.med.diff.tf <- obt.med.diff ## actual difference

##Spring
n1 <- length(rand.t.s$mn_var[rand.t.s$pair == "Within"])
n2 <- length(rand.t.s$mn_var[rand.t.s$pair == "Between"])
N <- n1 + n2
pair1 <-  rand.t.s$mn_var[rand.t.s$pair == "Within"]
pair2 <-  rand.t.s$mn_var[rand.t.s$pair == "Between"]


md1 <- median(pair1, na.rm = T)
md2 <- median(pair2, na.rm = T )


par(mfrow = c(2,1))
hist(pair1, col = "red", xlim = c(min(rand.t.s$mn_var), max(rand.t.s$mn_var)) )
hist(pair2, col = "green", xlim = c(min(rand.t.s$mn_var), max(rand.t.s$mn_var)))
dev.off()

obt.med.diff <- md1 - md2
cat("The actual median difference is ", '\n', obt.med.diff, '\n')

nreps = 10000
samp.med.diff <- numeric(nreps)
samp.med <- numeric(nreps)
for (i in 1:nreps) {
  resamp.rand.t.sa <- sample(rand.t.s$mn_var, length(rand.t.s$mn_var), replace = FALSE)
  Grp1 <-  resamp.rand.t.sa[1:n1]
  Grp2 <-  resamp.rand.t.sa[(n1+1):N]
  rmd1 <- median(Grp1, na.rm = T)
  rmd2 <- median(Grp2, na.rm = T )
  samp.med.diff[i] <- rmd1 - rmd2
  samp.med[i] <- rmd1
}
obt.med.diff <- abs(obt.med.diff)
pUpper <- length(samp.med.diff[samp.med.diff >= obt.med.diff]) /nreps
pLower <- length(samp.med.diff[samp.med.diff <= (-1)*obt.med.diff])/nreps

pExtreme.ts <- pLower + pUpper ##probability of optaining a difference as extreme as the actual sample
obt.med.diff.ts <- obt.med.diff ## actual difference within vs between

mdw.ts <- md1 ##median variance within individual in spring migration routes
mdb.ts <- md2 ## median variance between individuals in spring migration routes

```

```{r  btwn vs within migration route & HR overlap}
##does variation between individual increase at the same rate as variation within?

## compute a mean migration distance for between individual pairs
rand_traj_sum$id_birdyear <- paste(rand_traj_sum$id, rand_traj_sum$birdyear, sep = ".")
rand_traj_sum$p.id_birdyear <- paste(rand_traj_sum$p.id, rand_traj_sum$p.birdyear, sep = ".")
rand_traj_sum <- gull %>% select(id_birdyear, md1 = mig.dist) %>% right_join(rand_traj_sum)
rand_traj_sum <- rand_traj_sum %>%  select(p.id_birdyear) %>% left_join(gull, by = c("p.id_birdyear" = "id_birdyear")) %>% select(p.id_birdyear, md2 = mig.dist) %>% left_join(rand_traj_sum)
rand_traj_sum$med.mig <- rowMeans(rand_traj_sum[,c("md1","md2")])
rand_traj_sum$pair <- "between"

###combine within and between data sets into a single df for plotting later on
traj.s <- rbind(wtraj.s %>% select( mn_var = wvar, med.mig) %>% mutate(pair = "within"), 
                filter(rand_traj_sum, direction == "Spring") %>% select(mn_var, med.mig, pair)) %>% arrange(pair)
traj.f <- rbind(wtraj.f %>% select( mn_var = wvar, med.mig) %>% mutate(pair = "within"), 
                filter(rand_traj_sum, direction == "Autumn") %>% select(mn_var, med.mig, pair)) %>% arrange(pair)

lm(mn_var ~ med.mig, data = filter(traj.s, pair == 'between'))
lm(mn_var ~ med.mig, data = filter(traj.s, pair == 'within')) 
lm(mn_var ~ med.mig, data = filter(traj.f, pair == 'between')) 
lm(mn_var ~ med.mig, data = filter(traj.f, pair == 'within')) #

##spring
##Calculate between relationship
traj.s.btwn.lm <- lm(mn_var ~ med.mig, data = filter(traj.s, pair == 'between'))
traj.s.btwn.b <- coef(traj.s.btwn.lm)[1]
traj.s.btwn.m <- coef(traj.s.btwn.lm)[2]

traj.s.w <- filter(traj.s, pair == 'within')
traj.s.w$null <- traj.s.btwn.m*traj.s.w$med.mig + traj.s.btwn.b
traj.s.w$resid.var <- traj.s.w$mn_var - traj.s.w$null

##check for significance
dtraj.s.lm <- lm(resid.var ~ med.mig, data = traj.s.w)
dtraj.s.lm.0 <- lm(resid.var ~ 1, data = traj.s.w)
lrt.dtraj.s <- anova(dtraj.s.lm.0, dtraj.s.lm) ## residual overlap does not significantly increase with distance

#plot
ggplot(traj.s.w, aes(med.mig, resid.var)) + geom_point()## variation still slightly more than would be expected in longer migrants
##Autumn
##Calculate between relationship
traj.f.btwn.lm <- lm(mn_var ~ med.mig, data = filter(traj.f, pair == 'between'))
traj.f.btwn.b <- coef(traj.f.btwn.lm)[1]
traj.f.btwn.m <- coef(traj.f.btwn.lm)[2]

traj.f.w <- filter(traj.f, pair == 'within')
traj.f.w$null <- traj.f.btwn.m*traj.f.w$med.mig + traj.f.btwn.b
traj.f.w$resid.var <- traj.f.w$mn_var - traj.f.w$null

##check for significance
dtraj.f.lm <- lm(resid.var ~ med.mig, data = traj.f.w)
dtraj.f.lm.0 <- lm(resid.var ~ 1, data = traj.f.w)
lrt.dtraj.f <- anova(dtraj.f.lm.0, dtraj.f.lm) ## residual overlap does not significantly increase with distance

#plot
ggplot(traj.f.w, aes(med.mig, resid.var)) + geom_point() ## variation still slightly more than would be expected in longer migrants



### overlap
rand.UD_overlap_range <- gull %>% select(id = id_birdyear, md1 = mig.dist) %>% right_join(rand.UD_overlap_range)
rand.UD_overlap_range <- gull %>% select(p.id = id_birdyear, md2 = mig.dist) %>% right_join(rand.UD_overlap_range)
rand.UD_overlap_range$med.mig <- rowMeans(rand.UD_overlap_range[,c("md1","md2")])
rand.UD_overlap_range$pair <- "between"

###combine within and between data sets into a single df for plotting later on
ol <- rbind(rand.UD_overlap_range %>% select(overlap, med.mig, pair),
            wa.ol %>% ungroup() %>% select(overlap = mn_overlap, med.mig) %>% mutate(pair = "within"))

##Calculate between relationship
ol.btwn.lm <- lm(overlap ~ med.mig, data = filter(ol, pair == 'between'))
ol.btwn.b <- coef(ol.btwn.lm)[1]
ol.btwn.m <- coef(ol.btwn.lm)[2]

wa.ol$null <- ol.btwn.m*wa.ol$med.mig + ol.btwn.b
wa.ol$resid.var <- wa.ol$mn_overlap - wa.ol$null

##check for significance
wa.dol.lm <- lm(resid.var ~ med.mig, data = wa.ol)
wa.dol.lm.0 <- lm(resid.var ~ 1, data = wa.ol)
lrt.dol <- anova(wa.dol.lm.0, wa.dol.lm) ## residual overlap does significantly increase with distance

##plot
ggplot(wa.ol, aes(med.mig, resid.var)) + geom_point()

```

```{r colony departure lmm}

##population repeatability
r.cd <- rptR::rpt(col.depart ~ mig.dist + (1|col) + (1 | id), grname = c("id"), data = filter(gull, !is.na(col.depart))%>% mutate(mig.dist = mig.dist/1000), 
            datatype = "Gaussian", nboot = 1000, npermut = 0)
# r.cd.full <- rptR::rpt(col.depart ~ sex + scale(mig.dist) + (1|col) + (1 | id), grname = c("id"), data = filter(gull, !is.na(col.depart)), 
#             datatype = "Gaussian", nboot = 1000, npermut = 0)

lmm.cd <- lmer(col.depart ~ mig.dist + (1|col) + (1 | id), data = filter(gull, !is.na(col.depart)) %>% mutate(mig.dist = mig.dist/1000))
plot(lmm.cd)
#lmm.cd.full <- lmer(col.depart ~ sex + scale(mig.dist) + (1|col) + (1 | id), data = filter(gull, !is.na(col.depart)))

##Individual repeatability in colony departure
idres.cd <- data.frame(id = filter(gull, !is.na(col.depart))$id, resid = resid(lmm.cd))
idvar.cd <- idres.cd %>% group_by(id) %>% summarise(idvar = mean(resid^2)) ##calculate indivdiuals residual variance
idvar.cd <- filter(gull, !is.na(col.depart))%>% select(id, med.mig) %>% distinct() %>% full_join(idvar.cd)
btwnvar <- VarCorr(lmm.cd)[[1]][1]
idvar.cd$r <- btwnvar/(btwnvar+idvar.cd$idvar)

idvar.cd <- filter(gull, !is.na(col.depart)) %>% group_by(id) %>% summarise(range = max(col.depart) - min(col.depart)) %>% right_join(idvar.cd)

##linear model of indivdiual repeatability against migration distance
lm.cd <- lm(r~med.mig, data = idvar.cd)
lm.cd.n <- lm(r~1, data = idvar.cd)
lrt.cd <- anova(lm.cd.n, lm.cd) ## null

range.cd <- filter(gull, !is.na(col.depart)) %>% group_by(id) %>% summarise(range = max(col.depart) - min(col.depart)) ## range in individual departure dates
```

```{r Winter arrival lmm}
r.wa <- rptR::rpt(winter.arrive ~mig.dist + (1|col) + (1 | id) , grname = c("id"), data = filter(gull, !is.na(winter.arrive)) %>% mutate(mig.dist = mig.dist/1000), 
            datatype = "Gaussian", nboot = 1000, npermut = 0) ##population repeatability
# r.wa.full <- rptR::rpt(winter.arrive ~ sex + mig.dist + (1|col) + (1 | id), grname = c("id"), data = filter(gull, !is.na(winter.arrive)), 
#             datatype = "Gaussian", nboot = 1000, npermut = 0)

lmm.wa <- lmer(winter.arrive ~ mig.dist + (1|col) + (1 | id), data = filter(gull, !is.na(winter.arrive))%>% mutate(mig.dist = mig.dist/1000))
plot(lmm.wa)
# lmm.wa.full <- lmer(winter.arrive ~ sex + scale(mig.dist) + (1|col) + (1 | id), data = filter(gull, !is.na(winter.arrive)))
##individual repeatability
idres.wa <- data.frame(id = filter(gull, !is.na(winter.arrive))$id, resid = resid(lmm.wa))
idvar.wa <- idres.wa %>% group_by(id) %>% summarise(idvar = mean(resid^2)) ##calculate indivdiuals residual variance
idvar.wa <- filter(gull, !is.na(winter.arrive)) %>% select(id, med.mig) %>% distinct() %>% full_join(idvar.wa)
btwnvar <- VarCorr(lmm.wa)[[1]][1]
idvar.wa$r <- btwnvar/(btwnvar+idvar.wa$idvar)

##Does individual repeatability increase with migration distance?
lm.wa <- lm(r~med.mig, data = idvar.wa)
lm.wa.n <- lm(r~1, data = idvar.wa)
lrt.wa <- anova(lm.wa.n, lm.wa) ## null

fall.mig.time <- filter(gull, !is.na(winter.arrive))%>% mutate(mig.time.f = winter.arrive - col.depart) %>% summarise(mn = mean(mig.time.f), med = median(mig.time.f), max = max(mig.time.f), min = min(mig.time.f)) ## duration between col departure and winter arrive

range.wa <- filter(gull, !is.na(winter.arrive)) %>% group_by(id) %>% summarise(range = max(winter.arrive) - min(winter.arrive)) ## range in indivdiual arrival dates
```

```{r Winter departure}
r.wd <- rptR::rpt(winter.depart ~ mig.dist + (1|col) + (1 | id), grname = c("id"), data = gull %>% mutate(mig.dist = mig.dist/1000), 
            datatype = "Gaussian", nboot = 1000, npermut = 0)##population repeatability
# r.wd.full <- rptR::rpt(winter.depart ~ sex + mig.dist + (1|col) + (1 | id), grname = c("id"), data = gull, 
#             datatype = "Gaussian", nboot = 1000, npermut = 0)
##individual repeatability
lmm.wd <- lmer(winter.depart ~ mig.dist + (1|col) + (1 | id), data = gull%>% mutate(mig.dist = mig.dist/1000))
plot(lmm.wd)
# lmm.wd.full <- lmer(winter.depart ~ sex + scale(mig.dist) + (1|col) + (1 | id), data = gull)

idres.wd <- data.frame(id = gull$id, resid = resid(lmm.wd))
idvar.wd <- idres.wd %>% group_by(id) %>% summarise(idvar = mean(resid^2)) ##calculate indivdiuals residual variance
idvar.wd <- gull %>% select(id, med.mig) %>% distinct() %>% full_join(idvar.wd)
btwnvar <- VarCorr(lmm.wd)[[1]][1]
idvar.wd$r <- btwnvar/(btwnvar+idvar.wd$idvar)

## Does individual repeatability change with migration distance?
lm.wd <- lm(r~med.mig, data = idvar.wd)
lm.wd.n <- lm(r~1, data = idvar.wd)
lrt.wd <- anova(lm.wd.n, lm.wd) 

##range in individual departure dates
range.wd <- gull %>% group_by(id) %>% summarise(range = max(winter.depart) - min(winter.depart)) 
```

```{r colony arrival lmm}
##population repeatability
r.ca <- rptR::rpt(col.arrival ~ mig.dist + (1|col) + (1 | id), grname = c("id"), data = gull %>% mutate(mig.dist = mig.dist/1000), 
            datatype = "Gaussian", nboot = 1000, npermut = 0)

# r.ca.full <- rptR::rpt(col.arrival ~ sex + mig.dist + (1|col) + (1 | id), grname = c("id"), data = gull, 
#             datatype = "Gaussian", nboot = 1000, npermut = 0)

lmm.ca <- lmer(col.arrival ~ mig.dist + (1|col) + (1 | id), data = gull %>% mutate(mig.dist = mig.dist/1000))
plot(lmm.ca)
# lmm.ca.full <- lmer(col.arrival ~ sex + scale(mig.dist) + (1|col) + (1 | id), data = gull)

##individual repeatability
idres.ca <- data.frame(id = gull$id, resid = resid(lmm.ca))
idvar.ca <- idres.ca %>% group_by(id) %>% summarise(idvar = mean(resid^2)) ##calculate indivdiuals residual variance
idvar.ca <- gull %>% select(id, med.mig) %>% distinct() %>% full_join(idvar.ca)
btwnvar <- VarCorr(lmm.ca)[[1]][1]
idvar.ca$r <- btwnvar/(btwnvar+idvar.ca$idvar)

##does individual repeatability change with migration distance?
lm.ca <- lm(r~med.mig, data = idvar.ca)
lm.ca.n <- lm(r~1, data = idvar.ca)
lrt.ca <- anova(lm.ca.n, lm.ca) ## null

spring.mig.time <- gull %>% mutate(mig.time.s = col.arrival- winter.depart) %>% summarise(mn = mean(mig.time.s), med = median(mig.time.s), max = max(mig.time.s), min = min(mig.time.s)) ## duration of spring migration: from winter departure to colony arrival

range.ca <- gull %>% group_by(id) %>% summarise(range = max(col.arrival) - min(col.arrival)) ##individual ranges in colony arival date

```

```{r repeatable ids}
ol.df <- gull %>% select(id, mn_overlap) %>% distinct()
sf.df <- gull %>% select(id, sf_mn_overlap) %>% distinct()
plastic.id <- as.character(filter(idvar.ca, r <= quantile(idvar.ca$r, .05))$id)
plastic.id <- c(as.character(filter(idvar.cd, r <= quantile(idvar.cd$r, .05))$id),plastic.id)
plastic.id <-c(as.character(filter(idvar.wa, r <= quantile(idvar.wa$r, .05))$id),plastic.id)
plastic.id <-c(as.character(filter(idvar.wd, r <= quantile(idvar.wd$r, .05))$id),plastic.id)
plastic.id <-c(as.character(filter(wtraj.s, wvar >= quantile(wtraj.s$wvar, .95))$id),plastic.id)
plastic.id <-c(as.character(filter(wtraj.f, wvar >= quantile(wtraj.f$wvar, .95))$id),plastic.id)
plastic.id <-c(as.character(filter(ol.df, mn_overlap <= quantile(ol.df$mn_overlap, .05))$id),plastic.id)
plastic.id <-c(as.character(filter(sf.df, sf_mn_overlap <= quantile(sf.ol$sf_mn_overlap, .05))$id),plastic.id)

table(plastic.id)
n.variable <- length(unique(plastic.id))
```

 A total of `r length(gull$id)` nonbreeding seasons from `r length(unique(gull$id))` individuals remained in the study after data processing (Tables 1 and 2). 

#Results

A total of `r length(gull$id)` non-breeding seasons from `r length(unique(gull$id))` individuals remained after data processing, after the additional removal of 1 individual who remained within 10 km of the colony year round (Table 1, see supplementary material for a complete summary of tracking data, Table S1). For 4 individuals, the wintering area from one year was overlapping with multiple small polygons in another year – to make arrival and departure times to wintering areas comparable across years, these fragmented polygons were grouped into a single wintering area.

##Objective 1: How much inter- and intra-individual variation do lesser black-backed gulls have in their migratory behaviour?
Individuals used between `r min(gull$n.winter.p)` &ndash; `r max(gull$n.winter.p)` core areas during the nonbreeding season. For all but 5 individuals (n = `r length(unique(gull$id)) - length(no.wa.overlap)`), winter areas overlapped across all years. Wintering areas for these 5 individuals moved from France to Western Sahara, Mauritania to Portugal, France to UK, and 2 individuals moved from Morocco and UK. Migration distance was therefore highly repeatable (r= `r myround(r.md$R,2)` [`r myround(r.md$CI_emp[1],2)` - `r myround(r.md$CI_emp[2],2)`]). `r length(id.with.stop)` individuals used a stopover in at least one year,  and stopover areas were most commonly used in autumn. Use of stopover areas was less consistent than wintering areas: `r length(no.so.overlap$id)` out of `r length(id.with.stop)` individuals that used a stopover (`r round(length(no.so.overlap$id)/length(id.with.stop)*100)`%) having a stopover polygon that did not overlap with a polygon in another year (compared to `r round(length(no.wa.overlap)/length(unique(gull$id))*100)`% individuals who had non-overlapping wintering areas)

Despite some variation in stopover area use, mean overlap in non-breeding distributions was generally high, with a median overlap of `r myround(median(wa.ol$mn_overlap),2)` (range: `r myround(min(wa.ol$mn_overlap),2)` &ndash; `r myround(max(wa.ol$mn_overlap),2)`). Non-breeding distributions were significantly more similar within individuals across years than between individuals using similar migration strategies (median between-individual BA = `r myround(mdb.ol, 2)`, Fig. 2a and S2 in supplementary material), with none of the randomized sets producing a difference in median more extreme than the actual data (p < `r myround(pExtreme.ol, 3)`). Winter site-fidelity was generally moderate, with a median overlap of `r myround(median(gull$sf_mn_overlap),2)`, but  differed substantially among individuals (range: `r min(gull$sf_mn_overlap)` – `r myround(max(gull$sf_mn_overlap),2)`, Fig. 2b).

Intra-individual variation in migration route was low in both autumn (range =  `r  round(min(wtraj.f$wvar),0)` &ndash; `r round(max(wtraj.f$wvar),0)` km, median = `r round(mdw.tf,0)` km) and spring (range =  `r round(min(wtraj.s$wvar),0)` &ndash; `r round(max(wtraj.s$wvar),0)` km, median = `r round(mdw.ts,0)` km). Most inta-individual route variation occurred at the Bay of Biscay crossing (~ 500 km at the widest N-S crossing) and over the arid centre of Spain (also around 400 km directly N-S; Fig. 1). Intra-individual variation was significantly lower than variation found between paired individuals (autumn: between individual median = `r round(mdb.tf,0)` km; spring: between individual median = `r round(mdb.ts,0)` km; Fig. 2c-d and S2 in supplementary material) with probabilities of less than `r round(pExtreme.tf,0)` and `r signif(pExtreme.ts,3)`, of obtaining a difference in medians as extreme from a randomized set.

Departures from breeding colonies spanned a `r max(gull$col.depart, na.rm = T) - min(gull$col.depart, na.rm = T)` day period between `r jultodate(min(gull$col.depart, na.rm = T))` &ndash; `r jultodate(max(gull$col.depart, na.rm = T))` (Fig. 3a). The median range of departure dates within an individual was `r median(range.cd$range)` days (range: `r min(range.cd$range)` &ndash;  `r max(range.cd$range)`) and was highly repeatable (`r myround(r.cd$R,2)` [`r myround(r.cd$CI_emp[1],2)` - `r myround(r.cd$CI_emp[2],2)`]). Arrival to wintering area occurred between `r jultodate(min(gull$winter.arrive, na.rm = T))` &ndash;  `r jultodate(max(gull$winter.arrive, na.rm = T))` ((ranging `r max(gull$winter.arrive, na.rm = T) - min(gull$winter.arrive, na.rm = T)` days; Fig. 3b). Intra-individual arrival dates to wintering area ranged across years by  `r min(range.wa$range)` &ndash;  `r max(range.wa$range)` days (median = `r median(range.wa$range)`) and repeatability was high (`r myround(r.wa$R,2)` [`r myround(r.wa$CI_emp[1],2)`  - `r myround(r.wa$CI_emp[2],2)`]). During spring, the range of arrival and departure dates within individuals was more narrow, and repeatability values were higher than in autumn. Departure dates from wintering areas occurred within a `r max(gull$winter.depart) - min(gull$winter.depart)` day period between `r jultodate(min(gull$winter.depart))` - `r jultodate(max(gull$winter.depart))` (Fig. 3c). The median intra-individual range of departure dates was `r median(range.wd$range)` days (range: `r min(range.wd$range)` &ndash;  `r max(range.wd$range)`). Repeatability of departure from wintering area was high (`r myround(r.wd$R,2)` [`r myround(r.wd$CI_emp[1],2)` - `r myround(r.wd$CI_emp[2],2)`]). Arrival to breeding colonies occurred between `r jultodate(min(gull$col.arrival))` &ndash;  `r jultodate(max(gull$col.arrival))` (ranging `r max(gull$col.arrival) - min(gull$col.arrival)` days; Fig. 3d). Median intra-individual range in arrival dates to colony was `r min(range.ca$range)` &ndash;  `r max(range.ca$range)` days (median = `r median(range.ca$range)`). Repeatability was also high (`r myround(r.ca$R,2)` [`r myround(r.ca$CI_emp[1],2)` - `r myround(r.ca$CI_emp[2],2)`]). Linear mixed models and the variance partitioned toward the individual random effect and random error are reported in the supplementary material. 

While the majority of individuals tended to be highly consistent, for each behaviour a few individuals demonstrated high variability (e.g. Fig 1, Fig S5 in supplementary material).  The individuals demonstrating the most variability were not consistent across behaviours: `r n.variable` different individuals (`r myround(100*n.variable/length(unique(gull$id)),1)`%) were among the upper 5th percentile for variability in at least one of the 8 behaviours analyzed (Table S4 in supplementary material). 

##Objective 2: Does migration distance influence intra-individual variation in migratory behaviour?

Migration distances ranged from `r round(min(gull$mig.dist),0)` &ndash; `r round(max(gull$mig.dist),0)` km (median = `r round(median(gull$mig.dist),0)` km). Nonbreeding distribution overlap decreased with migration distance (overlap = `r myround(wa.ol.lm$coefficients[1],3)` + `r myround(wa.ol.lm$coefficients[2],6)`·migration distance, LRT: F = `r myround(lrt.ol$"F"[2],3)`, p = `r myround(lrt.ol$"Pr(>F)"[2],3)`; Fig. 2a). However variation increase at a significantly lower rate than the increase between individuals (residual overlap = `r myround(wa.dol.lm$coefficients[1],3)` + `r myround(wa.dol.lm$coefficients[2],3)`·migration distance, LRT: F = `r myround(lrt.dol$"F"[2],3)`, p = `r myround(lrt.dol$"Pr(>F)"[2],3)`; Fig s6a in supplemental material). Similarly, intra-individual route variation increased significantly with migration distance in spring, (variation = `r myround(lm.w.s$coefficients[1],3)` + `r myround(lm.w.s$coefficients[2],3)`·migration distance, LRT: F = `r myround(lrt.w.s$"F"[2],3)`, p = `r myround(lrt.w.s$"Pr(>F)"[2],3)`; Fig. 2d), but not autumn (LRT: F = `r myround(lrt.w.f$"F"[2],3)`, p = `r myround(lrt.w.f$"Pr(>F)"[2],3)`; Fig. 2c). Changes in route variation with migration distance did not, however, significantly differ from those observed between individuals (autumn LRT: F = `r myround(lrt.dtraj.f$"F"[2],3)`, p = `r myround(lrt.dtraj.f$"Pr(>F)"[2],3)`, spring LRT: F = `r myround(lrt.dtraj.s$"F"[2],3)`, p = `r myround(lrt.dtraj.s$"Pr(>F)"[2],3)`, Fig S6b-c in supplemental material).

Wintering area site fidelity did not change significantly with migration distance (LRT: F = `r myround(lrt.sf$"F"[2],3)`, p = `r myround(lrt.sf$"Pr(>F)"[2],3)`, Fig2b). Migration distance also did not correlate with repeatability in departure date from colony (LRT: F = `r myround(lrt.cd$"F"[2],3)`, p = `r myround(lrt.cd$"Pr(>F)"[2],3)`; Fig. 2e), arrival to wintering area (LRT: F = `r myround(lrt.wa$"F"[2],3)`, p = `r myround(lrt.wa$"Pr(>F)"[2],3)`; Fig. 2f), departure from wintering area (LRT: F = `r myround(lrt.wd$"F"[2],3)`, p = `r myround(lrt.wd$"Pr(>F)"[2],3)`; Fig. 2g) or arrival to colony (LRT: F = `r myround(lrt.ca$"F"[2],3)`, p = `r myround(lrt.ca$"Pr(>F)"[2],3)`; Fig. 2h).

```{r Table 1, include = T}
all_traj <- readRDS("all_traj.RDS") 
all_traj <- ungroup(all_traj) %>% arrange(id, time)

n_check <- all_traj %>% select(-time, -dur) %>% distinct() %>% arrange(id_birdyear)

##traj needs to be greater than 1 point
tmp <- n_check %>% filter(direction == "Spring") %>% select(id_birdyear, direction, lon, lat) %>% distinct()
nopath <- rle(tmp$id_birdyear)$values[which(rle(tmp$id_birdyear)$lengths <=1)]
all_traj <- filter(all_traj, !(id_birdyear %in% nopath & direction == "Spring"))
tmp <- n_check %>% filter(direction == "Autumn") %>% select(id_birdyear, direction, lon, lat) %>% distinct()
nopath <- rle(tmp$id_birdyear)$values[which(rle(tmp$id_birdyear)$lengths <=1)]
all_traj <- filter(all_traj, !(id_birdyear %in% nopath & direction == "Autumn"))

pair.miss <- all_traj %>% select(id, id_birdyear, direction) %>% distinct()
pair.miss <- pair.miss %>% group_by(id, direction) %>% summarise(n.years = n()) %>% filter(n.years <=1)

all_traj <- all_traj %>% left_join(pair.miss) %>% filter(is.na(n.years)) %>% select(-n.years)

tmp <- gull %>% select(id, birdyear, col) %>% mutate(id = as.numeric(as.character(id))) %>% distinct()
spring.seasons <- all_traj %>% select(id, birdyear, direction) %>% filter(direction == "Spring" & ! id %in% c(1402, 606, 5027, 5593, 534)) %>% distinct() %>%
  left_join(tmp)
fall.seasons <- all_traj %>% select(id, birdyear, direction) %>% filter(direction == "Autumn"& ! id %in% c(1402, 606, 5027, 5593, 534)) %>% distinct() %>% left_join(tmp)

n.id.md <- table((gull %>% select(id, col) %>% distinct())$col)
n.s.md <- table((gull %>% select(id, birdyear, col) %>% distinct())$col)
n.id.tf <-table((gull %>% select(id, col) %>% distinct() %>% right_join(wtraj.f))$col)
n.id.ts <-table((gull %>% select(id, col) %>% distinct() %>% right_join(wtraj.s))$col)
n.s.tf <-table((fall.seasons)$col)
n.s.ts <-table((spring.seasons)$col)

##Values per colony
rbind(n.id.md, n.id.tf, n.id.ts, n.s.md, n.s.tf, n.s.ts)
## Totals
sum(n.id.md)
sum(n.id.tf)
sum(n.id.ts)
sum(n.s.md)
sum(n.s.tf)
sum(n.s.ts)
```

```{r Fig. 1, include = T}
mn_traj_arr <- mn_traj %>% mutate(id = as.numeric(id)) 
mn_traj_arr <- mn_traj %>% group_by(id, direction) %>% summarise(max = max(within.var)) %>% arrange(max) %>% select(-max) %>% left_join(mn_traj)%>% ungroup() %>% mutate(id = factor(id, levels = unique(id))) ##put highest var first

col.pos <- data.frame(lat = c(54., 53.5, 53, 52.1, 51.7, 51.4, 51.3, 51.2),
                      long = c(-3.18, 6.26, 4.72, 1.58, -5.265, 3.7, 3.18, 2.93))

p.mig.var <- ggplot(map.world, aes(long, lat, group = group)) + geom_polygon(fill = "white", col = "black", size = 0.25) +
  geom_path(data = mn_traj_arr, aes(mn.lon, mn.lat, group = id, col = within.var), size = .55, alpha = .3, lineend = "round") + facet_wrap(~direction) +
  coord_fixed(xlim = c(min(mn_traj_arr$mn.lon), max(mn_traj_arr$mn.lon)), 
              ylim = c(min(mn_traj_arr$mn.lat), max(mn_traj_arr$mn.lat)),ratio = 1.2) + labs(col = "Variation (km)")+
  geom_point(data = col.pos, aes(group = NA), shape = 23, fill = "#FDE725FF", col = "black") +
 scale_colour_viridis_c() + theme_gray() + theme(axis.title = element_blank(), legend.position = c(.9,.2), legend.title= element_text(size = 9),  legend.text = element_text(size = 9), axis.text =element_text(size=8),legend.background = element_rect(fill = alpha("white", .75)))


pdf("Figure_1.pdf", height = 4.9, width = 4.7)
p.mig.var
dev.off()

```
Figure 1. Mean individual migration trajectories in autumn and spring based on GPS routes from 2 or more years. Route variability around the mean trajectory is shown by the route colour, with areas of highest variability being red. Colonies are indicated with yellow diamonds. .

```{r Fig. 2, include=T}
#r vs migration distance
wa.ol.lm.b <- lm(overlap ~ med.mig, data = filter(ol, pair == 'between'))

p.direction <- ggplot(wa.ol, aes(med.mig, resid.var)) + geom_blank() + 
  annotate("segment", x = 0.4, xend = 0.4, y = 0.26, yend = .10, size=.5, arrow=arrow(angle = 10, type = "closed", length = unit(0.1, "inches"))) + annotate("text", x = c(0,0, -.4), y = c(0.04,.32, .18),  label = c("High", "Low", "Variation"), angle = 90, size = 3) + xlim(-1,1) + theme_void()

p.ol <- ggplot(ol, aes(med.mig, overlap, col = pair)) + geom_point(size = 1) + geom_smooth(method = "lm",se=F, size = 1) + scale_color_manual(values = c("grey75", "black"))  + xlab("Individual median migration distance (km)")  + ylab("Non-breeding distribution Overlap") + scale_x_continuous(expand = c(0, 0)) + ggtitle('a') +
  theme_bw() +  theme(axis.title.x = element_blank(), axis.text =element_text(size=9),axis.title.y=element_text(size=9), legend.position = "none", panel.grid=element_blank(), plot.title=element_text(hjust=0), plot.background = element_blank(), plot.margin = margin(0, 3, -3, 3)) ##with 95% confidence interval

p.sf <- ggplot(sf.ol, aes(med.mig, sf_mn_overlap)) + geom_point(size = 1)   +  xlab("Individual median migration distance (km)")  + ylab("Winter area overlap") + scale_x_continuous(expand = c(0, 0)) + ggtitle('b') +
  theme_bw() +  theme(axis.title.x = element_blank(), axis.text =element_text(size=9),axis.title.y=element_text(size=9), legend.position = "none", panel.grid=element_blank(), plot.title=element_text(hjust=0), plot.background = element_blank(), plot.margin = margin(0, 3, -3, 3)) ##with 95% confidence interval

p.st <- ggplot(traj.s, aes(med.mig, mn_var, col = pair)) + geom_point(size = 1) + geom_smooth(method = "lm", se=F, size = 1) +
  scale_color_manual(values = c("grey75", "black"))+ ggtitle('d') +
  ylab("Spring route variation (km)") + theme_bw() + scale_x_continuous(expand = c(0, 0)) +
  theme(axis.title.x = element_blank(),axis.text =element_text(size=9), legend.position = "none", axis.title.y=element_text(size=9),panel.grid=element_blank(), plot.title=element_text(hjust=0), plot.background = element_blank(), plot.margin = margin(-3, 3, -3, 3)) + ylim(310, 0)

p.ft<-ggplot(traj.f, aes(med.mig, mn_var, col = pair)) + geom_point(size = 1) + geom_smooth(data = filter(traj.f, pair == "between"), method = "lm", se=F, size = 1, col = "grey75") +
  scale_color_manual(values = c("grey75", "black")) + 
    xlab("Individual median migration distance (km)") + ggtitle('c') +
  ylab("Autumn route variation (km)") + theme_bw() + scale_x_continuous(expand = c(0, 0)) +
  theme(axis.title.x = element_blank(),axis.text =element_text(size=9), legend.position = "none", axis.title.y=element_text(size=9), plot.background = element_blank(), panel.grid=element_blank(), plot.title=element_text(hjust=0), plot.margin = margin(-3, 3, -3, 3)) + ylim(310, 0)

p.cd <- ggplot(idvar.cd, aes(med.mig, r)) + geom_point(size = 1) +  ylab(expression(paste(R[i], "  of colony departures"))) + ylim(0,1) + scale_x_continuous(expand = c(0, 0)) + ggtitle('e') +
  xlab("Individual median migration distance (km)") + theme_bw() +    theme(axis.title.x=element_blank(),axis.text =element_text(size=9),axis.title.y=element_text(size=9), panel.grid=element_blank(), plot.title=element_text(hjust=0), plot.background = element_blank(), plot.margin = margin(-3, 3, -3, 3)) 

p.wa <- ggplot(idvar.wa, aes(med.mig, r)) + geom_point(size = 1) +  ylab(expression(paste(R[i], "  of winter arrivals"))) + ylim(0,1) + scale_x_continuous(expand = c(0, 0)) + ggtitle('f') +
  xlab("Individual median migration distance (km)") + theme_bw() +    theme(axis.title.x = element_blank(),axis.text =element_text(size=9),axis.title.y=element_text(size=9),plot.background = element_blank(), panel.grid=element_blank(), plot.title=element_text(hjust=0), plot.margin = margin(-3, 3, -3, 3))

p.wd <- ggplot(idvar.wd, aes(med.mig, r)) + geom_point(size = 1) +  ylab(expression(paste(R[i], "  of winter departures"))) + ylim(0,1) + scale_x_continuous(expand = c(0, 0)) + ggtitle('g') +
  xlab("Mean migration distance (km)") + theme_bw() +   theme(axis.text =element_text(size=9),axis.title=element_text(size=9), plot.background = element_blank(), panel.grid=element_blank(), plot.title=element_text(hjust=0), plot.margin = margin(-3, 3, 0, 3)) 

p.ca <- ggplot(idvar.ca, aes(med.mig, r)) + geom_point(size = 1) +  ylab(expression(paste(R[i], "  of colony arrivals"))) + ylim(0,1) + ggtitle('h') + scale_x_continuous(expand = c(0, 0)) +
  xlab("Mean migration distance (km)") + theme_bw() +   theme(axis.text =element_text(size=9),axis.title=element_text(size=9), plot.background = element_blank(), panel.grid=element_blank(), plot.title=element_text(hjust=0), plot.margin = margin(-3, 3, 0, 3)) 

#pdf("Figure_2.pdf",  width = 6.39, height = 7.87)
tiff("Fig2.tiff",  width = 16.25, height = 20, units = "cm", res = 300)
plot_grid(p.direction,p.ol, p.sf, p.direction,p.ft, p.st, p.direction,p.cd, p.wa, p.direction,p.wd, p.ca, nrow = 4, rel_widths= c(.1,1,1),rel_heights = c(1,1,1,1.15))
dev.off()

```
Figure 2. a) Mean overlap (Bhattacharyya’s affinity) in non-breeding season distribution, b) autumn and c) spring variation in migration routes, and repeatability in d) colony departure, e) arrival to furthest winter area, f) departure from furthest winter area, and g) colony arrival dates, across multiple non-breeding  seasons of individual lesser black-backed gulls, versus their maximum migration distance. Please note: the y-axis for autumn and spring route variation (b and c) is reversed so that the order of variation is consistent with other plots (from more to less variation). Black line showing trend predicted by the linear models were included if significant. Overlap (a) and route variation (b and c) from between individual pairs are plotted in grey.  
```{r Fig. 3, include=T}
gull.p <- gull  
gull.p$id <- reorder(gull.p$id, gull.p$mig.dist, FUN = median)  

p.r.cd <- ggplot(filter(gull.p, !is.na(col.depart)), aes(x = id, as.Date(col.depart-1, "1970-01-01"))) + 
   geom_tile(aes(id,y=min(as.Date(gull.p$col.depart-1, "1970-01-01"), na.rm=T), height = Inf, width = 1, fill = med.mig, size = 0), 
             data = filter(gull.p, !is.na(col.depart)) %>% group_by(id) %>% summarise(med.mig = median(mig.dist))) +
  geom_boxplot() + 
  annotate("text", x = 25, y = as.Date(min(gull.p$col.depart, na.rm = T), "1970-01-01"), 
           size = 4.5,label = paste0("R = ", myround(r.cd$R,2), "[", myround(r.cd$CI_emp[1],2), " - ", myround(r.cd$CI_emp[2],2), "]")) + 
  scale_y_date(breaks = as.Date(c(1,32,60,91,121,152,182,213,244,274,305,335,366, 397, 425, 456, 486, 517, 547)-1, "1970-01-01"), 
               date_labels = "%b") +
  ylab("Day of departure from colony") + xlab(expression("Short migration"%<-% "Individual" %->% "Long migration")) + 
  scale_fill_gradientn(colours=c("#9d869e", "#979ebf","#93c6cf", "#ace089","#fff289"))+ theme_bw() +  
   theme(axis.text.x=element_blank(), axis.title.x = element_blank(),
         axis.text.y=element_text(size=16),axis.title.y=element_text(size=18),
         panel.grid=element_blank(),legend.position = "none")  

p.r.wa <- ggplot(filter(gull.p, !is.na(winter.arrive)), aes(x =  id, as.Date(winter.arrive-1, "1970-01-01"))) + 
   geom_tile(aes(id,y=min(as.Date(gull.p$winter.arrive-1, "1970-01-01"), na.rm=T), height = Inf, width = 1, fill = med.mig), 
             data = filter(gull.p, !is.na(winter.arrive)) %>% group_by(id) %>% summarise(med.mig = median(mig.dist))) +
  geom_boxplot() +  
  annotate("text", x = 65, y = as.Date(min(gull.p$winter.arrive, na.rm=T), "1970-01-01"), size = 4.5,
           label =paste0("R = ", myround(r.wa$R,2), "[", myround(r.wa$CI_emp[1],2), " - ", myround(r.wa$CI_emp[2],2), "]")) +
  scale_y_date(breaks = as.Date(c(1,32,60,91,121,152,182,213,244,274,305,335,366, 397, 425, 456, 486, 517, 547)-1, "1970-01-01"), date_labels = "%b") +
  ylab("Day of arrival to winter area") + xlab(expression("Short migration"%<-% "Individual" %->% "Long migration")) + scale_fill_gradientn(colours=c("#9d869e", "#979ebf","#93c6cf", "#ace089","#fff289"))+ theme_bw() +  
    theme(axis.text.x=element_blank(), axis.title.x = element_blank(), axis.text.y =element_text(size=16),axis.title.y=element_text(size=18),panel.grid=element_blank(),legend.position = "none")  

p.r.wd <- ggplot(filter(gull.p, !is.na(winter.depart)), aes(x = id, as.Date(winter.depart-1, "1970-01-01"))) + 
  geom_tile(aes(id,y=min(as.Date(gull.p$winter.depart-1, "1970-01-01"), na.rm=T), height = Inf, width = 1, fill = med.mig),
             data = filter(gull.p, !is.na(winter.depart)) %>% group_by(id) %>% summarise(med.mig = median(mig.dist))) +
  geom_boxplot() +  annotate("text", x = 23, y = as.Date(min(gull.p$winter.depart), "1970-01-01"), size = 4.5, 
                             label = paste0("R = ", myround(r.wd$R,2), "[", myround(r.wd$CI_emp[1],2), " - ", myround(r.wd$CI_emp[2],2), "]")) + 
  scale_y_date(breaks = as.Date(c(1,32,60,91,121,152,182,213,244,274,305,335,366, 397, 425, 456, 486, 517, 547)-1, "1970-01-01"), date_labels = "%b") +
  ylab("Day of departure from winter area    ") + xlab(expression("Short migration"%<-% "Individual" %->% "Long migration")) +  
  scale_fill_gradientn(colours=c("#9d869e", "#979ebf","#93c6cf", "#ace089","#fff289"))+ theme_bw() +  
  theme(axis.text.x=element_blank(), axis.title.x=element_text(size=18), axis.text.y =element_text(size=16),axis.title.y=element_text(size=18),panel.grid=element_blank(),legend.position = "none") 

p.r.ca <- ggplot(filter(gull.p, !is.na(col.arrival)), aes(x = id, as.Date(col.arrival-1, "1970-01-01"))) + 
  geom_tile(aes(id,y=min(as.Date(gull.p$col.arrival-1, "1970-01-01"), na.rm=T), height = Inf, width = 1, fill = med.mig),
             data = filter(gull.p, !is.na(col.arrival)) %>% group_by(id) %>% summarise(med.mig = median(mig.dist))) +
 geom_boxplot() +  annotate("text", x = 65, y = as.Date(min(gull.p$col.arrival), "1970-01-01"), size = 4.5, label = paste0("R = ", myround(r.ca$R,2), "[", myround(r.ca$CI_emp[1],2), " - ", myround(r.ca$CI_emp[2],2), "]")) + 
  scale_y_date(breaks = as.Date(c(1,32,60,91,121,152,182,213,244,274,305,335,366, 397, 425, 456, 486, 517, 547)-1, "1970-01-01"), date_labels = "%b") +
  ylab("Day of arrival to colony ") + xlab(expression("Short migration"%<-% "Individual" %->% "Long migration"))  + 
  scale_fill_gradientn(colours=c("#9d869e", "#979ebf","#93c6cf", "#ace089","#fff289"))+  theme_bw() +  
  theme(axis.text.x=element_blank(), axis.text.y =element_text(size=16),axis.title.y=element_text(size=18), axis.title.x=element_text(size=18), panel.grid=element_blank(), legend.position = "none")


legend <- get_legend(
ggplot(filter(gull.p, !is.na(col.arrival)), aes(x = id, as.Date(col.arrival-1, "1970-01-01"))) + 
  geom_tile(aes(id,y=min(as.Date(gull.p$col.arrival-1, "1970-01-01"), na.rm=T), height = Inf, width = 1, fill = med.mig),alpha = .1,
             data = filter(gull.p, !is.na(col.arrival)) %>% group_by(id) %>% summarise(med.mig = median(mig.dist)) %>% ungroup())+
  geom_boxplot(aes(fill = med.mig),alpha = .5)+
  scale_fill_gradientn(colours=c("#9d869e", "#979ebf","#93c6cf", "#ace089","#fff289"), name="Migration \nDistance (km)")+
  theme(legend.box.margin = margin(0, 0, 0, 0),
        legend.direction = "horizontal", 
        legend.key.width = unit(2, "inches"),
        legend.text = element_text(size=16),
        legend.title =  element_text(size=16)
        )
)

fig3 <- plot_grid(p.r.cd, p.r.wa, p.r.wd, p.r.ca, nrow = 2, rel_heights = c(1,1.1), labels = "auto")

#pdf("Figure_3.pdf",  width = 12, height = 10)
tiff("Fig3.tiff",  width = 32, height = 24, units = "cm", res = 300)
plot_grid(fig3, legend, nrow = 2, rel_heights = c(2, .2))
dev.off()


```
Figure 3. The range of a) departure dates from colony, b) arrival dates to furthest wintering area, c) departure dates from furthest wintering area, and d) arrival dates to colony used across multiple non-breeding  seasons by individual Lesser Black-backed Gulls breeding in the Netherlands, Belgium and UK. In all subplots, the individuals are ordered by their longest recorded migration distance, with the shortest maximum migration distance on the left, and longest on the right. Repeatability (with 95% confidence intervals) is reported at the bottom of each plot.

#Supplimentary Material


Table S1. The number of Lesser black-backed gulls with a given number of nonbreeding seasons included in this study.
```{r Table S1, include = T}
n.id.md <-  as.vector(table(table(gull$id)))
n.yrs <- names(table(table(gull$id)))
n.id.tf <-  c(as.vector(table(table(fall.seasons$id))), 0, 0)
n.id.ts <-  c(as.vector(table(table(spring.seasons$id)))[1:4], 0, as.vector(table(table(spring.seasons$id)))[5])
df <- data.frame(n.yrs, n.id.md, n.id.tf,n.id.ts)
colnames(df) <- c("Number of Seasons", "Number of Individuals - migdist", "Number of Individuals - fall traj", "Number of Individuals - spring traj" )

kable(df, caption = "Table S1. The number of Lesser black-backed gulls with a given number of nonbreeding seasons included in this study.")
```

Figure S1 produced by LBBG_plasticity_pub.R

Figure S1. An example of how mean routes were computed. a) The GPS tracks (small points along a line) and core areas (shaded polygons) from ID 5524 during autumn.  GPS points within the core area polygons were removed to create a smoothed route. Colour represents different years. Rectangle indicates area shown in b-d. b) A zoomed in section of the routes  along which 100 equally spaced points were placed (500 points were used in actual analysis), and the beginning positions of the mean route (centre line). Points were coloured sequentially, such that the colour of the points along the GPS route that were averaged together correspond. Large points connected by lines indicate which points along the GPS tracks were averaged to create the mean route.  Faded lines connecting large points on the mean track  indicate the nearest-neighbour locations on the GPS track to these points. c) Location of mean route following 1 iteration, with solid line connecting the GPS points averaged to determine the position of select points along the mean route. The original mean route with nearest-neighbour points are indicated by faded points and lines. New points (teal) were added if points along the mean route were separated by more than 25 km. d) The final mean route, after 100 points were equally placed along the route (500 points used in actual analysis). Points on the mean route are coloured based on their variance (low = purple, high = yellow). Lines indicate the distances  between mean route and GPS routes used to calculate the variance for select points.

```{r Fig. S2, include = T}


#png("Figs2.png",  width = 16, height = 5.33, units = "cm", res = 600)
p.direction <- ggplot(wa.ol, aes(med.mig, resid.var)) + geom_blank() + 
  annotate("segment", x = 0.4, xend = 0.4, y = 0.6, yend = .15, size=.5, arrow=arrow(angle = 10, type = "closed", length = unit(0.1, "inches"))) + annotate("text", x = c(0,0, -.4), y = c(0.05,.675, .35),  label = c("High", "Low", "Variation"), angle = 90, size = 3) + xlim(-1,1) + ylim(0, .75) + theme_void()


# pdf("Figure_S2.pdf",  width = 6.3, height = 2.1)
tiff("Fig_s2.tiff",  width = 20, height = 6, units = "cm", res = 300)
plot_grid(p.direction,bp.ol, bp.tf, bp.ts, nrow = 1, rel_widths = c(.1,1,1,1))
dev.off()
```
Figure S2.  A comparison of a) nonbreeding season overlap, b) autumn route variation and c) spring route variation within versus between individuals.

Figure S3.  produced by LBBG_plasticity_pub.R
Figure S3. Examples of low (left) and high (right) nonbreeding distribution overlap for short (top), mid (middle) and long distance migrants (bottom).  The 25, 50, 75 and 95% contours are delineated, with the 50% contour used to identify core areas represented by the thicker line. The twice daily subsampled points used to make the utilization distributions are shown.  Contours and points are coloured by season. The device number (id) and overlap are reported above each plot.

```{r Fig S4 examples - rouve variation, include = T}
theme_set(theme_bw())
example.id <- c(5554,833,608, 537, 5337,540)
mn.ex <- filter(mn_traj, id %in% example.id)

#5554
ID <- example.id[1]
pts <- filter(all_traj, id == ID) %>% mutate(birdyear = factor(birdyear))
mn <- filter(mn.ex, id == ID)
RV <- filter(wtraj, id == ID) %>% pull(wvar)
pv5554<- ggplot(map.world, aes(long, lat, group = group)) + 
  geom_polygon(fill = "white", col = "black", size = .25) +
  #geom_polygon(data = p50, aes(fill = id,col = id), size = 1, alpha = .1) +
  geom_path(data=pts, aes(lon, lat, group = birdyear), size = .5) +
  #geom_point(data=pts, aes(lon, lat, group = NA), size = 1) +
  geom_point(data=mn, aes(mn.lon, mn.lat, group = NA, col = within.var), size = .75) +
  theme(legend.position = c(.85,.3), legend.background = element_rect(fill = alpha("white", .75)),axis.title = element_blank(), panel.background = element_rect(fill = "gray93"),
        panel.grid.major = element_line(colour= "white")) +
  scale_colour_viridis_c() +
  labs(col = "Variation \n (km)") +
  ggtitle(paste( " ID = ", ID, ", Mean Variation = ", round(RV, digits = 0), " km", ", Seasons = ", 
                 gull %>% filter(id == ID & !is.na(mig.dist)) %>% summarise(n = n()) %>% pull(n),sep = "")) +
  theme(plot.title = element_text(size = 11)) +
  coord_fixed(xlim = c(-10, 10), 
              ylim = c(38.5, 53),ratio = 1.2) ## add core areas
#833  
  ID <- example.id[2]
  pts <- filter(all_traj, id == ID & direction == "Autumn") %>% mutate(birdyear = factor(birdyear))
  mn <- filter(mn.ex, id == ID & direction == "Autumn")
  RV <- filter(wtraj.f, id == ID) %>% pull(wvar)
 pv833<- ggplot(map.world, aes(long, lat, group = group)) + 
    geom_polygon(fill = "white", col = "black", size = .25) +
   # geom_polygon(data = p50, aes(fill = id,col = id), size = 1, alpha = .1) +
    geom_path(data=pts, aes(lon, lat, group = birdyear), alpha = .75, size = .5) +
   # geom_point(data=pts, aes(lon, lat, group = NA), size = 1) +
    geom_point(data=mn, aes(mn.lon, mn.lat, group = NA, col = within.var), alpha = .5, size = .75) +
    theme(legend.position = c(.85,.3),legend.background = element_rect(fill = alpha("white", .75)),axis.title = element_blank(), panel.background = element_rect(fill = "gray93"),
          panel.grid.major = element_line(colour= "white")) +
    scale_colour_viridis_c() +
  ggtitle(paste( " ID = ", ID, ", Mean Variation = ", round(RV, digits = 0), " km", ", Seasons = ", 
                 gull %>% filter(id == ID & !is.na(mig.dist)) %>% summarise(n = n()) %>% pull(n),sep = "")) +
     theme(plot.title = element_text(size = 11)) +
   labs(col = "Variation \n (km)") +
  coord_fixed(xlim = c(-30, 22), 
              ylim = c(14, 52),ratio = 1.2) ## add core areas

#608
 ID <- example.id[3]
 pts <- filter(all_traj, id == ID & direction == "Spring") %>% mutate(birdyear = factor(birdyear))
 mn <- filter(mn.ex, id == ID & direction == "Spring")
 RV <- filter(wtraj.s, id == ID) %>% pull(wvar)
 pv608<- ggplot(map.world, aes(long, lat, group = group)) + 
   geom_polygon(fill = "white", col = "black", size = .25) +
   # geom_polygon(data = p50, aes(fill = id,col = id), size = 1, alpha = .1) +
   geom_path(data=pts, aes(lon, lat, group = birdyear), size = .5) +
  # geom_point(data=pts, aes(lon, lat, group = NA), size = 1) +
   geom_point(data=mn, aes(mn.lon, mn.lat, group = NA, col = within.var), size = .75) +
   theme(legend.position = c(.85,.3),legend.background = element_rect(fill = alpha("white", .75)),axis.title = element_blank(), panel.background = element_rect(fill = "gray93"),
         panel.grid.major = element_line(colour= "white")) +
   scale_colour_viridis_c() +
  ggtitle(paste( " ID = ", ID, ", Mean Variation = ", round(RV, digits = 0), " km", ", Seasons = ", 
                 gull %>% filter(id == ID & !is.na(mig.dist)) %>% summarise(n = n()) %>% pull(n),sep = "")) +
     theme(plot.title = element_text(size = 11)) +
   labs(col = "Variation \n (km)") +
   coord_fixed(xlim = c(-2, 5), 
               ylim = c(49, 54),ratio = 1.2) ## add core areas
 
##537
 ID <- example.id[4]
 pts <- filter(all_traj, id == ID & direction == "Autumn") %>% mutate(birdyear = factor(birdyear))
 mn <- filter(mn.ex, id == ID & direction == "Autumn")
 RV <- filter(wtraj.f, id == ID) %>% pull(wvar)
 pv537<- ggplot(map.world, aes(long, lat, group = group)) + 
   geom_polygon(fill = "white", col = "black", size = .25) +
   geom_path(data=pts, aes(lon, lat, group = birdyear), size = .5) +
  # geom_point(data=pts, aes(lon, lat, group = NA), size = 1) +
   geom_point(data=mn, aes(mn.lon, mn.lat, group = NA, col = within.var), size = .75) +
   theme(legend.position = c(.13,.3), legend.background = element_rect(fill = alpha("white", .75)),axis.title = element_blank(), panel.background = element_rect(fill = "gray93"),
         panel.grid.major = element_line(colour= "white")) +
   scale_colour_viridis_c() + 
  ggtitle(paste( " ID = ", ID, ", Mean Variation = ", round(RV, digits = 0), " km", ", Seasons = ", 
                 gull %>% filter(id == ID & !is.na(mig.dist)) %>% summarise(n = n()) %>% pull(n),sep = "")) +
     theme(plot.title = element_text(size = 11)) +
   labs(col = "Variation \n (km)") +
   coord_fixed(xlim = c(-2, 5), 
               ylim = c(49, 54),ratio = 1.2) ## add core areas 

##5337 
 ID <- example.id[5]
 pts <- filter(all_traj, id == ID & direction == "Autumn") %>% mutate(birdyear = factor(birdyear))
 mn <- filter(mn.ex, id == ID & direction == "Autumn")
 RV <- filter(wtraj.f, id == ID) %>% pull(wvar)
 pv5337<- ggplot(map.world, aes(long, lat, group = group)) + 
   geom_polygon(fill = "white", col = "black", size = .25) +
   # geom_polygon(data = p50, aes(fill = id,col = id), size = 1, alpha = .1) +
   geom_path(data=pts, aes(lon, lat, group = birdyear), size = .5) +
  # geom_point(data=pts, aes(lon, lat, group = NA), size = 1) +
   geom_point(data=mn, aes(mn.lon, mn.lat, group = NA, col = within.var), size = .75) +
   theme(legend.position = c(.85,.3),legend.background = element_rect(fill = alpha("white", .75)),axis.title = element_blank(), panel.background = element_rect(fill = "gray93"),
         panel.grid.major = element_line(colour= "white")) +
   scale_colour_viridis_c() + scale_fill_viridis_d(begin = .1, end = .8) +
  ggtitle(paste( " ID = ", ID, ", Mean Variation = ", round(RV, digits = 0), " km", ", Seasons = ", 
                 gull %>% filter(id == ID & !is.na(mig.dist)) %>% summarise(n = n()) %>% pull(n),sep = "")) +
     theme(plot.title = element_text(size = 11)) +
   labs(col = "Variation \n (km)") +
   coord_fixed(xlim = c(-10, 5), 
               ylim = c(40, 51),ratio = 1.2) ## add core areas

 ##540 
 ID <- example.id[6]
 pts <- filter(all_traj, id == ID & direction == "Spring") %>% mutate(birdyear = factor(birdyear))
 mn <- filter(mn.ex, id == ID & direction == "Spring")
 RV <- filter(wtraj.s, id == ID) %>% pull(wvar)
 pv540<- ggplot(map.world, aes(long, lat, group = group)) + 
   geom_polygon(fill = "white", col = "grey35", size = .25) +
   geom_path(data=pts, aes(lon, lat, group = birdyear), size = .5) +
  # geom_point(data=pts, aes(lon, lat, group = NA), size = 1) +
   geom_point(data=mn, aes(mn.lon, mn.lat, group = NA, col = within.var),size = .75) +
   theme(legend.position = c(.85,.3),legend.background = element_rect(fill = alpha("white", .75)),axis.title = element_blank(), panel.background = element_rect(fill = "gray93"),
         panel.grid.major = element_line(colour= "white")) +
   scale_colour_viridis_c() +
   ggtitle(paste( " ID = ", ID, ", Mean Variation = ", round(RV, digits = 0), " km", ", Seasons = ", 
                 gull %>% filter(id == ID & !is.na(mig.dist)) %>% summarise(n = n()) %>% pull(n),sep = "")) +
     theme(plot.title = element_text(size = 11)) +
   labs(col = "Variation \n (km)") +
   coord_fixed(xlim = c(-26, 22), 
               ylim = c(18, 53),ratio = 1.2) ## add core areas
 
 pdf("Figure_S4.pdf",  width = 7.87, height = 11.8)
 #png("FigS4.png",  width = 20, height = 30, units = "cm", res = 400)
 plot_grid(pv537, pv608, pv5337, pv5554, pv540, pv833, nrow = 3) 
 dev.off()
```
Figure S4. Examples of high (left) and low (right) route variation for short (top), mid (middle) and long distance migrants (bottom).  Black paths show GPS migration routes and mean route is coloured based on variation (scale differs per plot).  The device number (id) and mean variation are reported above each plot. 

Table S2. ‘Simple’ linear mixed model results for arrival and departure dates with individual as a random effect. T values are reported in brackets for the intercept. Individual variance is the variance of the individual-level random effect. Number of observations used in the models was 233, with 82 individuals. 
```{r Table S2, include = T}
kable(summary(lmm.cd)$varcor, digits = 5, caption = "Partitioning of variance in colony departure dates between random (individual) effect and residuals")
kable(summary(lmm.cd)$coef, digits = 5, caption = "Linear mixed model of individual colony departure date versus their maximum migration distance")

kable(summary(lmm.wa)$varcor, digits = 5, caption = "Partitioning of variance in winter arrival dates between random (individual) effect and residuals")
kable(summary(lmm.wa)$coef, digits = 5, caption = "Linear mixed model of individual winter arrival date versus their maximum migration distance")

kable(summary(lmm.wd)$varcor, digits = 5, caption = "Partitioning of variance in winter departure dates between random (individual) effect and residuals")
kable(summary(lmm.wd)$coef, digits = 5, caption = "Linear mixed model of individual winter departure date versus their maximum migration distance")

kable(summary(lmm.ca)$varcor, digits = 5, caption = "Partitioning of variance in colony arrival dates between random (individual) effect and residuals")
kable(summary(lmm.ca)$coef, digits = 5, caption = "Linear mixed model of individual colony arrival date versus their maximum migration distance")

```

Table S3. ‘Full’ linear mixed model results for arrival and departure dates against sex and migration distance with individual and colony as random effects. T values are reported in brackets for fixed effects, where colony variance is the variance of the colony-level random effect, and individual variance is the variance of the individual-level random effect. Number of observations used in the models was 229, with 8 colonies and 80 individuals.
```{r Table S3, include = T}
# kable(summary(lmm.cd.full)$varcor, digits = 5, caption = "Partitioning of variance in colony departure dates between random (individual) effect and residuals")
# kable(summary(lmm.cd.full)$coef, digits = 5, caption = "Linear mixed model of individual colony departure date versus their maximum migration distance")
# 
# kable(summary(lmm.wa.full)$varcor, digits = 5, caption = "Partitioning of variance in winter arrival dates between random (individual) effect and residuals")
# kable(summary(lmm.wa.full)$coef, digits = 5, caption = "Linear mixed model of individual winter arrival date versus their maximum migration distance")
# 
# kable(summary(lmm.wd.full)$varcor, digits = 5, caption = "Partitioning of variance in winter departure dates between random (individual) effect and residuals")
# kable(summary(lmm.wd.full)$coef, digits = 5, caption = "Linear mixed model of individual winter departure date versus their maximum migration distance")
# 
# kable(summary(lmm.ca.full)$varcor, digits = 5, caption = "Partitioning of variance in colony arrival dates between random (individual) effect and residuals")
# kable(summary(lmm.ca.full)$coef, digits = 5, caption = "Linear mixed model of individual colony arrival date versus their maximum migration distance")

```


```{r Figure S5, include = T}
##multi-pannel histogram

p.hol <- ggplot(ol.df, aes(mn_overlap))+ geom_histogram(col = "gray75") + 
  geom_vline(xintercept = quantile(ol.df$mn_overlap, .05), col = "red") + 
  xlab("Distribution Overlap") + ylab("Number of Individuals") + ylim(0,35) +xlim(0,1) +
  theme_bw() +  theme(axis.title.y =element_text(size=9), axis.text =element_text(size=9),
                      axis.title.x=element_text(size=9), legend.position = "none", panel.grid=element_blank()) 

p.hsf <- ggplot(sf.ol, aes(sf_mn_overlap))+ geom_histogram(col = "gray75") + 
  geom_vline(xintercept = quantile(sf.ol$sf_mn_overlap, .05), col = "red") + 
  xlab("Winter Area Overlap") + ylab("Number of Individuals") + ylim(0,35) +xlim(0,1) +
  theme_bw() +  theme(axis.title.y =element_text(size=9), axis.text =element_text(size=9),
                      axis.title.x=element_text(size=9), legend.position = "none", panel.grid=element_blank()) 


p.htf <- ggplot(wtraj.f, aes(wvar))+ geom_histogram(col = "gray75") + 
  geom_vline(xintercept = quantile(wtraj.f$wvar, .95), col = "red") +
  xlab("Autumn Route variation (km)") + ylab("Number of Individuals") + ylim(0,35) + scale_x_reverse(lim = c(225,0)) +
  theme_bw() +  theme(axis.title.y =element_text(size=9), axis.text =element_text(size=9),
                      axis.title.x=element_text(size=9), legend.position = "none", panel.grid=element_blank()) 

p.hts <- ggplot(wtraj.s, aes(wvar))+ geom_histogram(col = "gray75") + 
  geom_vline(xintercept = quantile(wtraj.s$wvar, .95),col = "red") +
  xlab("Spring Route variation (km)") + ylab("Number of Individuals") + ylim(0,35) + scale_x_reverse(lim = c(225,0)) +
  theme_bw() +  theme(axis.title.y =element_text(size=9), axis.text =element_text(size=9),
                      axis.title.x=element_text(size=9), legend.position = "none", panel.grid=element_blank()) 

p.hca <- ggplot(idvar.ca, aes(r))+ geom_histogram(col = "gray75") + 
  geom_vline(xintercept = quantile(idvar.ca$r, .05),col = "red") + 
  xlab(expression(paste(R[i], "  of colony arrivals"))) + ylab("Number of Individuals") + ylim(0,35) +xlim(0,1) +
  theme_bw() +  theme(axis.title.y =element_text(size=9), axis.text =element_text(size=9),
                      axis.title.x=element_text(size=9), legend.position = "none", panel.grid=element_blank()) 

p.hcd <- ggplot(idvar.cd, aes(r))+ geom_histogram(col = "gray75") + 
  geom_vline(xintercept = quantile(idvar.cd$r, .05),col = "red")+ 
  xlab(expression(paste(R[i], "  of colony departures"))) + ylab("Number of Individuals") + ylim(0,35) +xlim(0,1) +
  theme_bw() +  theme(axis.title.y =element_text(size=9), axis.text =element_text(size=9),
                      axis.title.x=element_text(size=9), legend.position = "none", panel.grid=element_blank()) 


p.hwa <- ggplot(idvar.wa, aes(r))+ geom_histogram(col = "gray75") + 
  geom_vline(xintercept = quantile(idvar.wa$r, .05),col = "red") + 
  xlab(expression(paste(R[i], "  of winter arrivals"))) + ylab("Number of Individuals") + ylim(0,35) +xlim(0,1) +
  theme_bw() +  theme(axis.title.y =element_text(size=9), axis.text =element_text(size=9),
                      axis.title.x=element_text(size=9), legend.position = "none", panel.grid=element_blank()) 

p.hwd <- ggplot(idvar.wd, aes(r))+ geom_histogram(col = "gray75") + 
  geom_vline(xintercept = quantile(idvar.wd$r, .05),col = "red") + 
  xlab(expression(paste(R[i], "  of winter deparures"))) + ylab("Number of Individuals") + ylim(0,35) + xlim(0,1) +
  theme_bw() +  theme(axis.title.y =element_text(size=9), axis.text =element_text(size=9),
                      axis.title.x=element_text(size=9), legend.position = "none", panel.grid=element_blank()) 


 pdf("Figure_S5.pdf",  width =3.94, height = 6.3)
# png("FigS5.png",  width = 10, height = 16, units = "cm", res = 400)
plot_grid(p.hol, p.hsf, p.htf, p.hts, p.hcd, p.hwa, p.hwd, p.hca, nrow = 4)
 dev.off()

```
Figure S5. Histograms of a) nonbreeding season overlap, b) autumn route variation, c) spring route variation, d) Individual-level repeatability (Ri) of departure date from colony, e) Ri of arrival date to wintering area, f) Ri of departure date from wintering area and g) Ri of arrival date to colony. Lines indicate the 95th percentile used to identify the most variable individuals in Table S4.

Table S3.  Individuals (device number) in and above the 95th percentile for each measure of variation in the indicated behaviour.  Individuals that were among the most variable for multiple behaviours are in bold. Asterix indicate individuals that did not overlap in their wintering area in one year. All values for overlap and repeatability (Ri) range from 0 to 1.
```{r Table S4, include = T}
filter(ol.df, mn_overlap <= quantile(ol.df$mn_overlap, .05)) %>% select(id,mn_overlap) %>% arrange(mn_overlap)

filter(sf.df, sf_mn_overlap <= quantile(sf.df$sf_mn_overlap, .05)) %>% select(id,sf_mn_overlap) %>% arrange(sf_mn_overlap)
#filter(sf.df, sf_mn_overlap <= quantile(sf.df$sf_mn_overlap, .06)) %>% select(id,sf_mn_overlap) %>% arrange(sf_mn_overlap)
filter(wtraj.f, wvar >= quantile(wtraj.f$wvar, .95)) %>% select(id, wvar) %>% arrange(wvar)
filter(wtraj.s, wvar >= quantile(wtraj.s$wvar, .95)) %>% select(id, wvar) %>% arrange(wvar)
filter(idvar.cd, r <= quantile(idvar.cd$r, .05)) %>% select(id,r) %>% arrange(r)
filter(idvar.wa, r <= quantile(idvar.wa$r, .05)) %>% select(id,r) %>% arrange(r)
filter(idvar.wd, r <= quantile(idvar.wd$r, .05)) %>% select(id,r) %>% arrange(r)
filter(idvar.ca, r <= quantile(idvar.ca$r, .05)) %>% select(id,r) %>% arrange(r)

##5027 534  606  1402 5593, no broadscale winter area overlap in at least 1 year

###5555 overlaps in broad wintering region, but not in fine-scale

varid <- c((filter(ol.df, mn_overlap <= quantile(ol.df$mn_overlap, .05)) %>% select(id,mn_overlap) %>% arrange(mn_overlap))$id,
(filter(wtraj.f, wvar >= quantile(wtraj.f$wvar, .95)) %>% select(id, wvar) %>% arrange(wvar))$id,
(filter(wtraj.s, wvar >= quantile(wtraj.s$wvar, .95)) %>% select(id, wvar) %>% arrange(wvar))$id,
(filter(idvar.cd, r <= quantile(idvar.cd$r, .05)) %>% select(id,r) %>% arrange(r))$id,
(filter(idvar.wa, r <= quantile(idvar.wa$r, .05)) %>% select(id,r) %>% arrange(r))$id,
(filter(idvar.wd, r <= quantile(idvar.wd$r, .05)) %>% select(id,r) %>% arrange(r))$id,
(filter(idvar.ca, r <= quantile(idvar.ca$r, .05)) %>% select(id,r) %>% arrange(r))$id)

##note: 5 individuals who moved wintering area are not included in route traj. 
length(unique(varid))
table(varid)

```

```{r Figure S6, include=T}

p.direction <- ggplot(wa.ol, aes(med.mig, resid.var)) + geom_blank() + 
  annotate("segment", x = 0.4, xend = 0.4, y = 0.3, yend = .1, size=.5, arrow=arrow(angle = 10, type = "closed", length = unit(0.1, "inches"))) + annotate("text", x = c(0,0, -.4), y = c(0.04,.36, .18),  label = c("High", "Low", "Variation"), angle = 90, size = 3) + xlim(-1,1) + theme_void()

p.olr <- ggplot(wa.ol, aes(med.mig, resid.var)) + geom_point(size = 1) + geom_smooth(method = "lm",se=F, size = 1, col = "black") + xlab("Mean migration distance (km)")  + ylab("Residual Distribution Overlap") + scale_x_continuous(expand = c(0, 0)) + ggtitle('a') +
  theme_bw() +  theme( axis.text =element_text(size=9),axis.title.y=element_text(size=9), legend.position = "none", panel.grid=element_blank(), plot.title=element_text(hjust=0), plot.background = element_blank(), plot.margin = margin(3, 3, 3, 3)) ##with 95% confidence interval

p.str <- ggplot(traj.s.w, aes(med.mig, resid.var)) + geom_point(size = 1) + ggtitle('c') +
  ylab("Residual spring route variation (km)") + xlab("Mean migration distance (km)")  + theme_bw() + scale_x_continuous(expand = c(0, 0)) +
  theme(axis.text =element_text(size=9), legend.position = "none", axis.title.y=element_text(size=9),panel.grid=element_blank(), plot.title=element_text(hjust=0), plot.background = element_blank(), plot.margin = margin(3, 3, 3, 3)) + ylim(125, -125)

p.ftr<-ggplot(traj.f.w,  aes(med.mig, resid.var)) + geom_point(size = 1) + ggtitle('b') +
  ylab("Residual spring route variation (km)") + xlab("Mean migration distance (km)")  + theme_bw() + scale_x_continuous(expand = c(0, 0)) +
  theme(axis.text =element_text(size=9), legend.position = "none", axis.title.y=element_text(size=9), plot.background = element_blank(), panel.grid=element_blank(), plot.title=element_text(hjust=0), plot.margin = margin(3, 3, 3, 3)) + ylim(125, -125)


# pdf("Figure_S6.pdf",  width = 7.87, height = 3.15)
tiff("Figs6.tiff",  width = 20, height = 8, units = "cm", res = 300)
plot_grid(p.direction, p.olr, p.ftr, p.str, nrow = 1, rel_widths = c(.1,1,1,1))
dev.off()

```